---
author: 
  name: "Seafood Globalization Lab"
  affiliation: "School of Aquatic and Fishery Sciences, University of Washington"
  orcid: "0000-0000-0000-0000"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: paper
    toc: yes
editor_options: 
  chunk_output_type: console
params: 
  countries_i: NULL
  country_i_dwf: NULL
  country_i_dwf_consump: NULL
  country_i_eez_fishing: NULL
  sciname_metadata: NULL
---

```{r setup, include=FALSE}

# set global code chunk options
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# load packages
library(rmarkdown)
library(knitr) # Need package version 1.44 or up for quarto
library(countrycode) # convert and standardize country id
library(magrittr) # pipe function
library(ggplot2) # visualization
library(forcats) #reorder factors
library(stringr)
library(purrr) 
# install old version of exploreARTIS
#install_github("Seafood-Globalization-Lab/exploreARTIS@c0f34b90172f716068c9b98df5ed491ca5085162")
# install AM updates branch, force new install, and do not update global enviro package versions
install_github("Seafood-Globalization-Lab/exploreARTIS@AM-updates",
               upgrade = "never", 
               force = TRUE)
library(exploreARTIS) # custom ARTIS viz package 

country_iso3c <- params$countries_i

# iso3c to country name
country_name <- countrycode(params$countries_i,
                            origin = "iso3c",
                            destination = "country.name")

```

---
title: "Oceana Distant Water Fishing Report: `r country_name`"
---

# Introduction

This report provides an analysis of `r country_name`'s distant water fishing.

# Data Analysis

```{r}
# pull out parameters to Rmd environment - contains dwf = foreign and domestic
country_i_dwf <- params$country_i_dwf
country_i_dwf_consump <- params$country_i_dwf_consump
country_i_eez_fishing <- params$country_i_eez_fishing

# 1) focal country DWF activities
dwf_for <- country_i_dwf %>% 
  filter(dwf == "foreign")
  # domestic reference
dwf_dom <- country_i_dwf %>% 
  filter(dwf != "foreign")

# 2) focal country consumption 
  # fish caught in its own water
dwf_con_dom <- country_i_dwf_consump %>% 
  filter(eez_iso3c == country_iso3c)
  # caught in a different
dwf_con_for <- country_i_dwf_consump %>% 
  filter(eez_iso3c != country_iso3c)
    
# 3) Fishing activity in focal country EEZ
eez_for <- country_i_eez_fishing %>% 
  filter(dwf == "foreign")
  # domestic reference
eez_dom <- country_i_eez_fishing %>% 
  filter(dwf != "foreign")
```


## DWF Activities by `r country_name`

### Percent of catch in foreign waters over time

```{r prct-dwf}
# calc total catch
catch_total_yr <- country_i_dwf %>% 
  group_by(year) %>% 
  summarise(total_catch = sum(live_weight_t))

# calc total dwf catch & join to total catch
catch_dwf_yr <- dwf_for %>% 
  group_by(year) %>% 
  summarize(dwf_catch = sum(live_weight_t)) %>% 
  left_join(catch_total_yr, by = "year") %>% 
  mutate(prct_dwf = dwf_catch/total_catch)

# Line time series percent of total catch in foreign waters
(fig_dwf_prct <- catch_dwf_yr %>% 
  ggplot(aes(year,prct_dwf)) +
    geom_line() +
    theme_bw() +
    labs(y = "Percent Catch in Foreign Waters",
         x = "") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                       limits = c(0,1))
)
```

### DWF catch by EEZ

```{r}
# DWF catch x EEZ x year

exploreARTIS::plot_ts(dwf_for,
                      artis_var = "eez_name",
                      #plot.title = "DWF Catch by EEZ",
                      prop_flow_cutoff = 0.05,
                      plot.type = "stacked",
                      legend.title = "EEZ"
                      )
```

### Top Species Caught via DWF

```{r}
# Filter last 5 years of data
max_year <- max(dwf_for$year)
last_5_yrs <- seq(max_year - 4, max_year, by = 1)

dwf_for_5yr <- dwf_for %>% 
  filter(year %in% last_5_yrs)
```


Mean for the last 5 years of data (`r paste0(last_5_yrs)`)

```{r eval=TRUE}

exploreARTIS::plot_bar(data = dwf_for_5yr,
                       bar_group = "sciname",
                       #common_names = TRUE,
                       x.lab = "Quantity (tons live weight)")
```

## DWF Exports by `r country_name`

Consumption of top 6 species caught via DWF (not including NA)

```{r}

top_6_sp <- dwf_for_5yr %>% 
  group_by(sciname) %>% 
  summarise(total_live_weight_t = sum(live_weight_t)) %>% 
  arrange(desc(total_live_weight_t)) %>% 
  slice_head(n = 6) %>% 
  left_join(sciname_metadata, by = "sciname") 

dwf_for_con <- dwf_for_5yr %>% 
  filter(sciname %in% top_6_sp$sciname) %>% 
  ungroup()

plot_ts(dwf_for_con,
        artis_var = "consumer_iso3c",
        prop_flow_cutoff = 0.05,
        plot.type = "stacked",
        legend.title = "Consumer")
```


### Consumption of Top DWF Species - Caught by `r country_name`

```{r}
knitr::kable(top_6_sp %>% 
               select(common_name, 
                      sciname, 
                      total_live_weight_t),
            col.names = c("Common name", 
                          "Scientific name", 
                          "Total live weight (tons)"))
```

```{r}
# Renaming hack to make consumption work with exploreARTIS::plot_sankey()
dwf_for_con_sanky <- dwf_for_con %>% 
  rename(exporter_iso3c = producer_iso3c,
         importer_iso3c = consumer_iso3c,
         source_country_iso3c = eez_iso3c) %>% 
  select(-c(eez_name,dwf))
```

Sankey Diagram Key:
Source EEZ --> Producer --> Consumer

```{r echo=FALSE, results='hide', fig.keep='all'}

purrr::map(top_6_sp$sciname, ~ plot_sankey(dwf_for_con_sanky %>% 
                                             filter(.x == sciname),
                                           plot.title = .x))
```

## `r country_name`'s consumption of DWF-sourced products

### Fish caught `r country_name`'s own waters
```{r eval=FALSE}
# need fill to be producer nation

plot_ts(dwf_con_dom,
        artis_var = "exporter_iso3c",
        prop_flow_cutoff = 0.05,
        plot.type = "stacked",
        legend.title = ""
        )
```

```{r eval=FALSE}

plot_ts(dwf_con_for,
        artis_var = "eez_name",
        prop_flow_cutoff = 0.05,
        plot.type = "stacked",
        legend.title = "EEZ"
        )
```

