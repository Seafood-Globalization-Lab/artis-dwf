---
author: 
  name: "Seafood Globalization Lab"
  affiliation: "School of Aquatic and Fishery Sciences, University of Washington"
date: "`r Sys.Date()`"
output: 
  cleanrmd::html_document_clean:
    theme: almond
    toc: yes
    toc_depth: 2
    number_sections: true
    number_serctions_depth: 2
editor_options: 
  chunk_output_type: console
params: 
  countries_i: NULL
  country_i_dwf: NULL
  country_i_consump: NULL
  country_i_eez_fishing: NULL
  sciname_metadata: NULL
---

```{r setup, include=FALSE}

# set global code chunk options
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# load packages
library(rmarkdown)
library(knitr) # Need package version 1.44 or up for quarto
library(countrycode) # convert and standardize country id
library(magrittr) # pipe function
library(ggplot2) # visualization
library(forcats) #reorder factors
library(stringr)
library(purrr) # iteration 
library(scales) # adjust display of plot numbers
library(cowplot) # arange plots together
# install old version of exploreARTIS
#install_github("Seafood-Globalization-Lab/exploreARTIS@c0f34b90172f716068c9b98df5ed491ca5085162")
# install AM updates branch, force new install, and do not update global enviro package versions
# install_github("Seafood-Globalization-Lab/exploreARTIS@AM-updates",
#                upgrade = "never", 
#                force = TRUE)
library(exploreARTIS) # custom ARTIS viz package 

country_iso3c <- params$countries_i

# iso3c to country name
country_name <- countrycode(params$countries_i,
                            origin = "iso3c",
                            destination = "country.name")

# read in annotations script
knitr::read_chunk(file.path(anndir, 
                            glue::glue({country_iso3c},".R")))

```

---
title: "Oceana Distant Water Fishing Report: `r country_name`"
---

# Introduction

This report provides an analysis of `r country_name`'s distant water fishing.

# Data Analysis

```{r}
# pull out parameters to Rmd environment - contains dwf = foreign and domestic
country_i_dwf <- params$country_i_dwf
country_i_consump <- params$country_i_consump
country_i_eez_fishing <- params$country_i_eez_fishing

# 1) focal country DWF activities
dwf_frgn <- country_i_dwf %>% 
  filter(dwf == "foreign")
  # domestic reference
dwf_dom <- country_i_dwf %>% 
  filter(dwf != "foreign")

# 2) Focal country's consumption 
  # a) fish caught in its own waters (regardless of who is fishing)
consum_dom <- country_i_consump %>% 
  filter(eez_iso3c == country_iso3c)
  # b) fish caught in different waters: 
    #  - domestic production by a different country (trade)
    #  - dwf production from a different country (trade)
    #  - focal country's dwf catch
consum_frgn <- country_i_consump %>% 
  filter(eez_iso3c != country_iso3c)
  # c) country's consumption of DWF fish
consum_dwf <- country_i_consump %>% 
  filter(dwf == "foreign")
    
# 3) Fishing activity in focal country EEZ by other countries
eez_frgn <- country_i_eez_fishing %>% 
  filter(dwf == "foreign")
  # domestic reference - same as dwf_dom
eez_dom <- country_i_eez_fishing %>% 
  filter(dwf != "foreign")
```


## DWF Activities by `r country_name`

### Percent DWF of total catch

```{r prct-dwf}
# calc total catch
catch_total_yr <- country_i_dwf %>% 
  group_by(year) %>% 
  summarise(total_catch = sum(live_weight_t))

# calc total dwf catch & join to total catch
catch_dwf_yr <- dwf_frgn %>% 
  group_by(year) %>% 
  summarize(dwf_catch = sum(live_weight_t)) %>% 
  left_join(catch_total_yr, by = "year") %>% 
  mutate(prct_dwf = dwf_catch/total_catch)

# Line time series percent of total catch in foreign waters
(fig_dwf_prct <- catch_dwf_yr %>% 
  ggplot(aes(year,prct_dwf)) +
    geom_line() +
    theme_bw() +
    labs(y = "Percent Catch in Foreign Waters",
         x = "") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                       limits = c(0,1))
)
```

```{r, figure_1, results='asis'}
```

### DWF catch by EEZ

```{r}
# DWF catch x EEZ x year

exploreARTIS::plot_ts(dwf_frgn,
                      artis_var = "eez_name",
                      #plot.title = "DWF Catch by EEZ",
                      prop_flow_cutoff = 0.05,
                      plot.type = "stacked",
                      legend.title = "Source EEZ"
                      ) +
  scale_y_continuous(labels = scales::comma)
```

### Top Species Caught via DWF

```{r}
# Filter last 5 years of data
max_year <- max(dwf_frgn$year)
last_5_yrs <- seq(max_year - 4, max_year, by = 1)

dwf_frgn_5yr <- dwf_frgn %>% 
  filter(year %in% last_5_yrs) %>% 
  left_join(sciname_metadata, by = "sciname")
```


Sum for the last 5 years of data (`r paste0(last_5_yrs)`)

```{r eval=TRUE}

exploreARTIS::plot_bar(data = dwf_frgn_5yr,
                       bar_group = "common_name",
                       x.lab = "Quantity (tons live weight)",
                       top_n = 6) +
  scale_x_continuous(labels = scales::comma)
```

## DWF Exports by `r country_name`

Consumption of top 6 species caught by `r country_name` via DWF `r paste0(last_5_yrs)` (not including NA)

```{r}

top_6_sp <- dwf_frgn_5yr %>% 
  group_by(sciname, common_name) %>% 
  summarise(total_live_weight_t = sum(live_weight_t),
            .groups = "drop") %>% 
  arrange(desc(total_live_weight_t)) %>% 
  slice_head(n = 6)

dwf_frgn_consum <- dwf_frgn_5yr %>% 
  filter(sciname %in% top_6_sp$sciname) %>% 
  ungroup()

plot_ts(dwf_frgn_consum,
        artis_var = "consumer_iso3c",
        prop_flow_cutoff = 0.05,
        plot.type = "stacked",
        legend.title = "Consumer") +
  scale_y_continuous(labels = scales::comma)
```


### Top DWF Species caught by `r country_name` (`r paste0(last_5_yrs)`)

```{r}
knitr::kable(top_6_sp %>% 
               select(common_name, 
                      sciname, 
                      total_live_weight_t),
            col.names = c("Common name", 
                          "Scientific name", 
                          "live weight (tons)"))
```

### DWF flows (source EEZ --> Producer --> Consumer)

```{r echo=FALSE, results='hide', fig.keep='all'}

dwf_frgn_consum_sankey <- dwf_frgn_consum %>% 
  filter(year %in% last_5_yrs) %>% 
  exploreARTIS::add_country_name("producer_iso3c") %>% 
  exploreARTIS::add_country_name("consumer_iso3c")

purrr::map(top_6_sp$common_name, 
           ~ plot_sankey(dwf_frgn_consum_sankey %>% filter(.x == common_name),
                         cols = c("eez_name", 
                                  "producer_iso3c_name",
                                  "consumer_iso3c_name"),
                         plot.title = .x))
```

## `r country_name` Consumption of DWF 

### `r country_name` consumption of catch from its own waters
```{r fig.width=11}
# consum_dom is  Focal country consumption of catch in its own waters
# could be domestic catch or catch by a different nation
# need fill to be producer nation
# function not updated yet

consum_dom_dom_plot <- consum_dom %>%
  filter(dwf == "domestic",
         producer_iso3c == country_iso3c) %>% 
  mutate(producer_name = countrycode(producer_iso3c,
                                     origin = "iso3c",
                                     destination = "country.name"))

consum_dom_frgn_plot <- consum_dom %>% 
  filter(dwf == "foreign",
         producer_iso3c != country_iso3c) %>% 
  mutate(producer_name = countrycode(producer_iso3c,
                                     origin = "iso3c",
                                     destination = "country.name"))

plot1 <- plot_ts(consum_dom_dom_plot,        
                 artis_var = "producer_name",
                 prop_flow_cutoff = 0.05,
                 plot.type = "stacked",
                 plot.title = "Domestic production"
                 ) +
  scale_y_continuous(labels = scales::comma)

plot2 <- plot_ts(consum_dom_frgn_plot,        
                 artis_var = "producer_name",
                 prop_flow_cutoff = 0.05,
                 plot.type = "stacked",
                 plot.title = "Foreign fleet production"
                 )
# combine plot side-by-side
cowplot::plot_grid(plot1, plot2)
```

### Fish consumed by `r country_name` from another country's waters

```{r fig.width=11}
 # facet line plot - - Other EEZ

# create facet variable for 3 other EEZ consumption scenarios:
 #    domestic production by a different country
 #    dwf production from a different country
 #    focal country dwf
consum_frgn_facet <- consum_frgn %>% 
  mutate(
    consum_foreign = case_when(
      dwf == "domestic" & producer_iso3c != country_iso3c ~ 
        "Foreign domestic\nproduction",
      dwf == "foreign" & producer_iso3c != country_iso3c ~ 
        "Foreign DWF\nproduction",
      dwf == "foreign" & producer_iso3c == country_iso3c ~
        glue("{country_name} DWF\nproduction")),
    producer_name = countrycode::countrycode(producer_iso3c,
                                             origin = "iso3c",
                                             destination = "country.name")
  )

(consum_frgn_facet_plot <- plot_ts(consum_frgn_facet,
                                  artis_var = "producer_name",
                                  plot.type = "stacked",
                                  facet_variable = "consum_foreign",
                                  facet_values = 3,
                                  prop_flow_cutoff = 0.05) +
    scale_y_continuous(labels = scales::comma)
  )

```

### Top 6 species consumed by `r country_name` -- Caught via DWF (includes `r country_name` and other countries)

```{r}
# Filter last 5 years of data
max_year <- max(consum_dwf$year)
last_5_yrs <- seq(max_year - 4, max_year, by = 1)

consum_dwf_5yr <- consum_dwf %>% 
  filter(year %in% last_5_yrs) %>% 
  exploreARTIS::add_country_name("producer_iso3c") %>% 
  exploreARTIS::add_country_name("consumer_iso3c") %>% 
  left_join(sciname_metadata, by = "sciname") 

```

Sum for the last 5 years of data (`r paste0(last_5_yrs)`)

```{r eval=TRUE}

exploreARTIS::plot_bar(data = consum_dwf_5yr,
                       bar_group = "common_name",
                       x.lab = "Quantity (tons live weight)",
                       top_n = 6) +
  scale_x_continuous(labels = scales::comma)
```

```{r}

top_6_sp <- consum_dwf_5yr %>% 
  group_by(sciname, common_name) %>% 
  summarise(total_live_weight_t = mean(live_weight_t),
            .groups = "drop") %>% 
  arrange(desc(total_live_weight_t)) %>% 
  slice_head(n = 6)

knitr::kable(top_6_sp %>% 
               select(common_name, 
                      sciname, 
                      total_live_weight_t),
            col.names = c("Common name", 
                          "Scientific name", 
                          "Mean live weight per year (tons)"))
```

### DWF consumption flows (Source EEZ --> Producer --> Consumer)

```{r echo=FALSE, results='hide', fig.keep='all'}

purrr::map(top_6_sp$common_name, 
           ~ plot_sankey(consum_dwf_5yr %>% filter(.x == common_name),
                         cols = c("eez_name", 
                                  "producer_iso3c_name",
                                  "consumer_iso3c_name"),
                         plot.title = .x))
```

