---
author: 
  name: "Seafood Globalization Lab"
  affiliation: "School of Aquatic and Fishery Sciences, University of Washington"
  orcid: "0000-0000-0000-0000"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
params: 
  countries_i: NULL
  artis_eez_i: NULL
  artis_sau_i: NULL

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# load packages
library(rmarkdown)
#library(quarto)
library(knitr) # Need package version 1.44 or up for quarto
library(countrycode)
library(magrittr)

```

---
title: "Oceana Distant Water Fishing Report: `r params$countries_i`"
---

# Introduction

This report provides an analysis of `r params$countries_i` distant water fishing in `r year_int`

# Data Analysis

## Landings mass check
```{r eval=F}

# landings mass check - filter
artis_sau_check <- artis_sau %>% 
  filter(habitat == "marine", 
         method == "capture", 
         year == year_int, 
         source_country_iso3c == "CHN")

# e^-6 or e^-9 considered 0 - haven't gained or lost any mass
mass_diff <- sum(an_artis_eez$live_weight_t) - sum(artis_sau_check$live_weight_t)

nrow_artis_eez <- nrow(an_artis_eez) 
```

The difference between ARTIS live weight (tons) and SAU live weight (tons) is x.

The number of rows in ARTIS EEZ is x. 


```{r, echo=FALSE}

# print top 25 DWF species
top_25 <- params$artis_eez_i %>% 
  filter(dwf == "foreign") %>%
  group_by(sciname) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_head(n = 25) # limits df to first 25 rows

knitr::kable(
  top_25, caption = 'Top 25 DWF Species'
)
```

### Graphs

#### `r top_25[[1,1]]`

loop through this graph generation?

```{r, echo=FALSE, fig.cap="Source Country Without Catch EEZ Information"}

# plot artis_sau$source_country_iso3c (without catch eez information)
params$artis_eez_i %>%
 # select(-source_country_iso3c) %>%
 # rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[1,1]]) %>%
  plot_sankey()
```

```{r, echo=FALSE, fig.cap="EEZ of Catch for Source Country"}

# plot with catch eez information
params$artis_eez_i %>%
  select(-source_country_iso3c) %>%
  rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[1,1]]) %>%
  plot_sankey()
```

#### `r top_25[[2,1]]`

```{r, echo=FALSE, fig.cap="Source Country Without Catch EEZ Information"}

# plot artis_sau$source_country_iso3c (without catch eez information)
params$artis_eez_i %>%
 # select(-source_country_iso3c) %>%
 # rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[2,1]]) %>%
  plot_sankey()
```

```{r, echo=FALSE, fig.cap="EEZ of Catch for Source Country"}

# plot with catch eez information
params$artis_eez_i %>%
  select(-source_country_iso3c) %>%
  rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[2,1]]) %>%
  plot_sankey()
```

**To DO List**

- Focal country’s DWF activities: percent of catch in foreign waters, stacked line of waters they caught in, top species caught via DWF
- Focal country’s exports from DWF: Top 4 or 6 species caught via DWF and create stacked line graph of who consumes that. For a recent year (or few years) create sankey for each species (focal country will be far second to the left - farthest left is EEZ) column of sankey). Use consumption table for this. Sankey columns will be EEZ, source country, exporter, consumer.
- Focal country’s imports of DWF-sourced products -  Top 4 or 6 species caught via DWF and create stacked line graph of EEZ for those. For a recent year (or few years) create sankey for each species (focal country will be far right column of sankey). Use consumption table for this. Sankey columns will be EEZ, source country, exporter, consumer.
- Note: Can use exploreARTIS packages to assist with these figures. For NGO reports, it is good to replace scientific name with the common name using the sciname_metadata table.
