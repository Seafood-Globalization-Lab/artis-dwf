---
author: 
  name: "Seafood Globalization Lab"
  affiliation: "School of Aquatic and Fishery Sciences, University of Washington"
  orcid: "0000-0000-0000-0000"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: simplex
    toc: yes
editor_options: 
  chunk_output_type: console
params: 
  countries_i: NULL
  country_i_dwf: NULL
  country_i_dwf_consump: NULL
  country_i_eez_fishing: NULL
---

```{r setup, include=FALSE}

# set global code chunk options
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# load packages
library(rmarkdown)
library(knitr) # Need package version 1.44 or up for quarto
library(countrycode) # convert and standardize country id
library(magrittr) # pipe function
library(ggplot2) # visualization
library(exploreARTIS) # custom ARTIS viz package 
library(forcats) #reorder factors
library(stringr)

# iso3c to country name
country_name <- countrycode(params$countries_i,
                            origin = "iso3c",
                            destination = "country.name")

```

---
title: "Oceana Distant Water Fishing Report: `r country_name`"
---

# Introduction

This report provides an analysis of `r country_name`'s distant water fishing.

# Data Analysis

```{r}
# pull out parameters to Rmd environment - contains dwf = foreign and domestic
country_i_dwf <- params$country_i_dwf
country_i_dwf_consump <- params$country_i_dwf_consump
country_i_eez_fishing <- params$country_i_eez_fishing

# 1) focal country DWF activities
country_i_dwf_for <- country_i_dwf %>% 
  filter(dwf == "foreign")
  # domestic reference
country_i_dwf_dom <- country_i_dwf %>% 
  filter(dwf != "foreign")

# 2) focal country consumption of DWF catch
country_i_dwf_con_for <- country_i_dwf_consump %>% 
  filter(dwf == "foreign")
  # domestic reference
country_i_dom_con_dom <- country_i_dwf_consump %>% 
  filter(dwf != "foreign")
    
# 3) Fishing activity in focal country EEZ
country_i_eez_for <- country_i_eez_fishing %>% 
  filter(dwf == "foreign")
  # domestic reference
country_i_eez_dom <- country_i_eez_fishing %>% 
  filter(dwf != "foreign")
```


## DWF Activities by `r country_name`

### Percent of catch in foreign waters over time

```{r prct-dwf}
# calc total catch
catch_total_yr <- country_i_dwf %>% 
  group_by(year) %>% 
  summarise(total_catch = sum(live_weight_t))

# calc total dwf catch & join to total catch
catch_dwf_yr <- country_i_dwf_for %>% 
  group_by(year) %>% 
  summarize(dwf_catch = sum(live_weight_t)) %>% 
  left_join(catch_total_yr, by = "year") %>% 
  mutate(prct_dwf = dwf_catch/total_catch)

# Line time series percent of total catch in foreign waters
(fig_dwf_prct <- catch_dwf_yr %>% 
  ggplot(aes(year,prct_dwf)) +
    geom_line() +
    theme_bw() +
    labs(y = "Percent Catch in Foreign Waters",
         x = "") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                       limits = c(0,1))
)
```

### DWF catch by EEZ

```{r}
# DWF catch x EEZ x year

exploreARTIS::plot_ts(country_i_dwf_for,
                      artis_var = "source_country_eez_name",
                      #plot.title = "DWF Catch by EEZ",
                      prop_flow_cutoff = 0.05,
                      plot.type = "stacked",
                      legend.title = "EEZ"
                      )
```

### Top Species Caught via DWF

```{r}
# Filter last 5 years of data
max_year <- max(country_i_dwf_for$year)
last_5_yrs <- seq(max_year - 4, max_year, by = 1)

country_i_dwf_for_5yr <- country_i_dwf_for %>% 
  filter(year %in% last_5_yrs)
```


Mean for the last 5 years of data (`r paste0(last_5_yrs)`)

```{r eval=TRUE}

exploreARTIS::plot_bar(data = country_i_dwf_for_5yr,
                       bar_group = "sciname",
                       common_names = TRUE,
                       x.lab = "Quantity (tons live weight)")
```

## DWF Exports by `r country_name`

Consumption of top 6 species caught via DWF

```{r}
top_6_sp <- country_i_dwf_for_5yr %>% 
  group_by(sciname) %>% 
  summarise(total_live_weight_t = sum(live_weight_t)) %>% 
  arrange(desc(total_live_weight_t)) %>% 
  slice_head(n = 6)

country_i_dwf_for_con <- country_i_dwf_for_5yr %>% 
  filter(sciname %in% top_6_sp$sciname) 

plot_ts(country_i_dwf_for_con,
        artis_var = "consumer_iso3c",
        prop_flow_cutoff = 0.05,
        plot.type = "stacked",
        legend.title = "Consumer")
```

### Consumption of Top DWF Species

```{r}
# country_i_dwf_for_con_sp <- country_i_dwf_for_con %>% 
#   filter(sciname == top_6_sp$sciname[1])

plot_sankey(country_i_dwf_for_con,
            species = top_6_sp$sciname[1],
            prop_flow_cutoff = 0.05,
            
            )
```

