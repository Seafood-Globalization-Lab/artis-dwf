---
author: 
  name: "Seafood Globalization Lab"
  affiliation: "School of Aquatic and Fishery Sciences, University of Washington"
  orcid: "0000-0000-0000-0000"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
params: 
  countries_i: NULL
  artis_eez_i: NULL
  artis_sau_i: NULL

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE,
                      warning = FALSE)

# load packages
library(rmarkdown)
#library(quarto)
library(knitr) # Need package version 1.44 or up for quarto
library(countrycode)
library(magrittr)
library(ggplot2)

```

---
title: "Oceana Distant Water Fishing Report: `r params$countries_i`"
---

# Introduction

This report provides an analysis of `r params$countries_i` distant water fishing in `r year_int`

# Data Analysis

```{r last-5-years}
# calculate last 5 years in country specific data
max_year <- max(artis_eez_i$year)
last_5_yrs <- seq(max_year - 4, max_year, by = 1)

# df with focal countries most recent 5 years of data
artis_eez_i_5yr <- artis_eez_i %>% 
  filter(year %in% last_5_yrs)
```


## `r params$countries_i`'s DWF Activities

### Percent of catch in foreign waters over time

```{r}
catch_total_yr <- artis_eez_i_5yr %>% 
  group_by(year) %>% 
  summarise(total_catch = sum(live_weight_t))

catch_dwf_yr <- artis_eez_i_5yr %>% 
  filter(dwf == "foreign") %>% 
  group_by(year) %>% 
  summarize(dwf_catch = sum(live_weight_t)) %>% 
  left_join(catch_total_yr, by = "year") %>% 
  mutate(prct_dwf = dwf_catch/total_catch)

catch_prct_dwf <- catch_dwf_yr %>% 
  left_join(catch_total_yr, by = "year") %>% 
  mutate(prct_dwf = dwf_catch/total_catch)

(fig_dwf_prct <- catch_prct_dwf %>% 
  ggplot(aes(year,prct_dwf)) +
    geom_line() +
    theme_bw() +
    labs(y = "Percent Catch in Foreign Waters",
         x = "") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                       limits = c(0,1),
                       expand = c(0, 0))
)
```


```{r, echo=FALSE}

# print top 25 DWF species
top_25 <- params$artis_eez_i %>% 
  filter(dwf == "foreign") %>%
  group_by(sciname) %>%
  summarise(live_weight_t = sum(live_weight_t)) %>%
  arrange(desc(live_weight_t)) %>%
  slice_head(n = 25) # limits df to first 25 rows

knitr::kable(
  top_25, caption = 'Top 25 DWF Species'
)
```




#### `r top_25[[1,1]]`

loop through this graph generation?

```{r, echo=FALSE, fig.cap="Source Country Without Catch EEZ Information"}

# plot artis_sau$source_country_iso3c (without catch eez information)
params$artis_eez_i %>%
 # select(-source_country_iso3c) %>%
 # rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[1,1]]) %>%
  plot_sankey()
```

```{r, echo=FALSE, fig.cap="EEZ of Catch for Source Country"}

# plot with catch eez information
params$artis_eez_i %>%
  select(-source_country_iso3c) %>%
  rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[1,1]]) %>%
  plot_sankey()
```

#### `r top_25[[2,1]]`

```{r, echo=FALSE, fig.cap="Source Country Without Catch EEZ Information"}

# plot artis_sau$source_country_iso3c (without catch eez information)
params$artis_eez_i %>%
 # select(-source_country_iso3c) %>%
 # rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[2,1]]) %>%
  plot_sankey()
```

```{r, echo=FALSE, fig.cap="EEZ of Catch for Source Country"}

# plot with catch eez information
params$artis_eez_i %>%
  select(-source_country_iso3c) %>%
  rename("source_country_iso3c" = "catch_artis_iso3") %>%
  filter(sciname == top_25[[2,1]]) %>%
  plot_sankey()
```
