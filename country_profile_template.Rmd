---
author: |
  | University of Washington
  | School of Aquatic and Fishery Sciences
  | Seafood Globalization Lab
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  tufte::tufte_handout:
    latex_engine: xelatex
header-includes:
  - \usepackage{placeins}
params: 
  countries_i: NULL
  country_i_dwf: NULL
  country_i_consump: NULL
  country_i_eez_fishing: NULL
  foc_logic: NULL
---

```{r setup, include=FALSE, cache=FALSE}

# set global code chunk options
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                     # fig.fullwidth = TRUE,
                      fig.width = 6,
                      fig.asp = 0.618,
                    #  fig.show = "hold",
                    #  fig.pos='ht',
                    #  out.width = "70%",
                    #  fig.align = "center",
                      eval.after = "fig.cap", # eval code first then options
                      cache = TRUE)

# load packages
library(rmarkdown)
library(knitr) # Need package version 1.44 or up for quarto
library(countrycode) # convert and standardize country id
library(magrittr) # pipe function
library(ggplot2) # visualization
library(forcats) #reorder factors
library(stringr)
library(purrr) # iteration 
library(scales) # adjust display of plot numbers
library(cowplot) # arange plots together
# install old version of exploreARTIS
#install_github("Seafood-Globalization-Lab/exploreARTIS@c0f34b90172f716068c9b98df5ed491ca5085162")
# install AM updates branch, force new install, and do not update global enviro package versions
# install_github("Seafood-Globalization-Lab/exploreARTIS@AM-updates",
#                upgrade = "never", 
#                force = TRUE)
library(exploreARTIS) # custom ARTIS viz package 
library(shadowtext) # custom labeling on horizontal bar figures

# load parameter into object
country_iso3c <- params$countries_i

foc_logic <- params$foc_logic

# iso3c to country name
country_name <- countrycode(country_iso3c,
                            origin = "iso3c",
                            destination = "country.name")

# read in annotations script
knitr::read_chunk(file.path(anndir, 
                            glue::glue({country_iso3c},".R")))

# knitr hook to prevent figure floating 
knitr::knit_hooks$set(plot = function(x, options)  {
  paste0(knitr::hook_plot_tex(x, options), "\n\\FloatBarrier\n")
})

```

---
title: |
  | Oceana Distant Water Fishing Report: 
  | `r country_name`
---

# Overview

This report provides an analysis of distant water fishing (DWF) related to `r country_name`. We define distant water fishing as capture fishery landings that occur in the exclusive economic zone (EEZ) of a country other than the flag of the country. 

There are three aspects of distant water fishing investigated in this report:

1) DWF activities by other nations within the focal country's EEZ
2) The focal country's own DWF activities
3) The focal country's consumption of aquatic foods sourced via DWF (conducted by them or another country)

```{r, eval = foc_logic == TRUE, results='asis'}
cat(paste0("**Please note**: ", country_name, " been declared a flag of convience (FOC) by the International Transport Workers Federation's (ITF) Fair Practices Committee (a joint committee of ITF seafarers' and dockers' unions), which runs the ITF campaign against FOCs as of ", format(Sys.Date(), '%B %d, %Y'), ". This status may affect the following results, including by increasing apparent consumption of aquatic foods."))
```

```{r create-dataframes}
# pull out parameters to Rmd environment - contains dwf = foreign and domestic
country_i_dwf <- params$country_i_dwf
country_i_consump <- params$country_i_consump
country_i_eez_fishing <- params$country_i_eez_fishing

# 1) focal country DWF activities
dwf_frgn <- country_i_dwf %>% 
  filter(dwf == "foreign")
  # domestic reference
dwf_dom <- country_i_dwf %>% 
  filter(dwf != "foreign")
  # top 6 species caught via dwf
top_6_sp_dwf <- dwf_frgn %>% 
  group_by(sciname, common_name) %>% 
  # total live weight (tons)
  summarise(live_weight_t = sum(live_weight_t),
            .groups = "drop") %>% 
  arrange(desc(live_weight_t)) %>% 
  slice_head(n = 6)

# 2) Focal country's consumption 
  # a) fish caught in its own waters (regardless of who is fishing)
consum_dom <- country_i_consump %>% 
  filter(eez_iso3c == country_iso3c)
  # b) fish caught in different waters: 
    #  - domestic production by a different country (trade)
    #  - dwf production from a different country (trade)
    #  - focal country's dwf catch
consum_frgn <- country_i_consump %>% 
  filter(eez_iso3c != country_iso3c)
  # c) country's consumption of DWF fish
consum_dwf <- country_i_consump %>% 
  filter(dwf == "foreign")
  # add country names
consum_dwf <- consum_dwf %>% 
  exploreARTIS::add_country_name("producer_iso3c") %>% 
  exploreARTIS::add_country_name("consumer_iso3c")
  # top 6 species consumed 
top_6_sp_consum <- consum_dwf %>% 
  group_by(sciname, common_name) %>% 
  # total live_weight
  summarise(live_weight_t = mean(live_weight_t),
            .groups = "drop") %>% 
  arrange(desc(live_weight_t)) %>% 
  slice_head(n = 6)
    
# 3) Fishing activity in focal country EEZ by other countries
eez_frgn <- country_i_eez_fishing %>% 
  filter(dwf == "foreign")
  # domestic reference - same as dwf_dom
eez_dom <- country_i_eez_fishing %>% 
  filter(dwf != "foreign")
  # top species 
top_6_sp_eez_frgn <- eez_frgn %>% 
  group_by(sciname, common_name) %>% 
  # total live_weight
  summarise(live_weight_t = mean(live_weight_t),
            .groups = "drop") %>% 
  arrange(desc(live_weight_t)) %>% 
  slice_head(n = 6)
```

```{r find-NA-values, eval = FALSE}
# -- For report development only --
# Record missing common_name values for correction in run-analysis-report.R
# add manual correction in the creation of `sciname_common` object.

# DWF species
top_6_csv <- read_csv(file.path("output", "common_name_na.csv"))

na_rows_dwf <- top_6_sp_dwf %>% 
  filter(is.na(common_name))

top_6_csv <- rbind(top_6_csv, na_rows_dwf)

# Consumption species
na_rows_consum <- top_6_sp_consum %>% 
  filter(is.na(common_name))

top_6_csv <- rbind(top_6_csv, na_rows_consum)
write_csv(top_6_csv, file.path("output", "common_name_na.csv"))
```

# Results

## 1) DWF in `r country_name`'s EEZ by other countries

```{r}
# new figure --
# Time series of percent of catch in Mexico’s EEZ that is caught by foreign nations, possibly as a panel with Fig 20 (fig-line-eez-dwf) below.  
```

```{r fig-line-eez-dwf, fig.cap=paste0("The quantity of distant water fishing caught in ", country_name, " EEZ waters by forign countries")}

eez_frgn_plot <- eez_frgn %>% 
  exploreARTIS::add_country_name("producer_iso3c") %>% 
  exploreARTIS::add_country_name("consumer_iso3c")

# Check if the dataframe is empty
if (nrow(eez_frgn_plot) == 0) {
  # Create a new dataframe with the necessary structure and zero values
  eez_frgn_plot <- data.frame(
    year = unique(country_i_eez_fishing$year),
    producer_iso3c_name = "None",
    live_weight_t = 0  
  )
}

exploreARTIS::plot_ts(eez_frgn_plot,
                      artis_var = "producer_iso3c_name",
                      prop_flow_cutoff = 0.05,
                      plot.type = "stacked",
                      legend.title = "DWF country"
                      ) +
  scale_y_continuous(labels = scales::comma)
  
```

```{r, 20-fig-line-eez-dwf, results='asis'}
```

```{r fig-bar-sp-eez-dwf, eval= nrow(eez_frgn) > 0, fig.cap=paste0("Top species caught in ", country_name, "  waters caught via DWF by foreign countries. Sum of the most recent years of data available (", paste(unique(eez_frgn$year), collapse = ", "), ").")}
# Only displays if data is available

exploreARTIS::plot_bar(data = top_6_sp_eez_frgn,
                               bar_group = "common_name",
                               x.lab = "Quantity (tons live weight)") +
  scale_x_continuous(labels = scales::comma) +
  # Add quantity labels for values below the threshold (outside of bar)
  geom_shadowtext(
    data = subset(top_6_sp_eez_frgn, 
                  live_weight_t < max(top_6_sp_eez_frgn$live_weight_t) * 0.8), 
    aes(x = live_weight_t, y = common_name, 
        label = scales::comma(round(live_weight_t))),
    hjust = 0,
    nudge_x = 0.025 * max(top_6_sp_eez_frgn$live_weight_t), # Dynamic nudge value
    colour = "#114F59", # default RGB color from plot_bar
    bg.colour = "white",
    bg.r = 0.2,
    size = 3
  ) +
  # Add quantity labels for values above the threshold (inside bar)
  geom_text(
    data = subset(top_6_sp_eez_frgn, 
                  live_weight_t >= max(top_6_sp_eez_frgn$live_weight_t) * 0.8),
    aes(x = live_weight_t, y = common_name, 
        label = scales::comma(round(live_weight_t))),
    hjust = 1,
    nudge_x = -0.02 * max(top_6_sp_eez_frgn$live_weight_t), # Adjust the nudge value
    colour = "white",
    size = 3
  )
```

```{r ,eval= nrow(eez_frgn) == 0, results='asis'}
# markdown text only appears if no data
cat(paste0("There is no recorded DWF occuring in ", country_name, " EEZ waters by other countries."))
```

```{r, 21-fig-bar-sp-eez-dwf, results='asis'}
```

```{r}
# New Figure --
# Sankey of overall flow (4 columns) with species, EEZ, producer, consumer (or possibly drop species if the 4 columns make it too messy) – focal country will be EEZ in all cases here
```


## 2) `r country_name` DWF Activities 

```{r fig-prct-dwf, eval= TRUE, fig.cap= paste0("Percent of ", country_name, " total catch that is distant water fishing for most recent available data")}
# calc total catch
catch_total_yr <- country_i_dwf %>% 
  group_by(year) %>% 
  summarise(total_catch = sum(live_weight_t))

# calc total dwf catch & join to total catch
catch_dwf_yr <- dwf_frgn %>% 
  group_by(year) %>% 
  summarize(dwf_catch = sum(live_weight_t)) %>% 
  left_join(catch_total_yr, by = "year") %>% 
  mutate(prct_dwf = dwf_catch/total_catch)

# Check if the dataframe is empty
if (nrow(catch_dwf_yr) == 0) {
  # Create a new dataframe with the necessary structure and zero values
  catch_dwf_yr <- data.frame(
    year = unique(country_i_dwf$year),
    prct_dwf = 0
  )
}

# Line time series percent of total catch in foreign waters
(fig_dwf_prct <- catch_dwf_yr %>% 
  ggplot(aes(year,prct_dwf)) +
    geom_line() +
    theme_bw() +
    labs(y = "Percent Catch in Foreign Waters",
         x = "") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), 
                       limits = c(0,1))
)
```

```{r, 1-fig-prct-dwf, results='asis'}
```

```{r fig-line-dwf-eez, eval= TRUE, fig.cap=paste0("The quantity of distant water fishing caught by ", country_name, " by the source EEZ it was caught in by year")}

exploreARTIS::plot_ts(dwf_frgn,
                      artis_var = "eez_name",
                      #plot.title = "DWF Catch by EEZ",
                      prop_flow_cutoff = 0.05,
                      plot.type = "stacked",
                      legend.title = "Source EEZ"
                      ) +
  scale_y_continuous(labels = scales::comma)
```

```{r, 2-fig-line-dwf-eez, results='asis'}
```

**Note**: Data is filtered to the last 5 years of available data.

```{r fig-bar-dwf-species, eval= nrow(dwf_frgn) > 0, fig.cap=paste0("Top species caught via distant water fishing by tons of live weight. Sum for the last 5 years of available data (", paste(unique(dwf_frgn$year), collapse = ", "), ")")}

exploreARTIS::plot_bar(data = top_6_sp_dwf,
                               bar_group = "common_name",
                               x.lab = "Quantity (tons live weight)") +
  scale_x_continuous(labels = scales::comma) +
  # Add quantity labels for values below the threshold (outside of bar)
  geom_shadowtext(
    data = subset(top_6_sp_dwf, 
                  live_weight_t < max(top_6_sp_dwf$live_weight_t) * 0.8), 
    aes(x = live_weight_t, y = common_name, 
        label = scales::comma(round(live_weight_t))),
    hjust = 0,
    nudge_x = 0.025 * max(top_6_sp_dwf$live_weight_t), # Dynamic nudge value
    colour = "#114F59", # default RGB color from plot_bar
    bg.colour = "white",
    bg.r = 0.2,
    size = 3
  ) +
  # Add quantity labels for values above the threshold (inside bar)
  geom_text(
    data = subset(top_6_sp_dwf, 
                  live_weight_t >= max(top_6_sp_dwf$live_weight_t) * 0.8),
    aes(x = live_weight_t, y = common_name, 
        label = scales::comma(round(live_weight_t))),
    hjust = 1,
    nudge_x = -0.02 * max(top_6_sp_dwf$live_weight_t), # Adjust the nudge value
    colour = "white",
    size = 3
  )
```

```{r, eval = nrow(dwf_frgn) == 0, results='asis'}
cat(paste0("There is no recorded DWF by ", country_name, " in other countries EEZs."))
```

```{r, 3-fig-bar-dwf-species, eval= nrow(dwf_frgn) > 0, results='asis'}
```

```{r}
# New Figure --
# Sankey of overall flow (4 columns) with species, EEZ, producer, consumer (or possibly drop species if the 4 columns make it too messy) – focal country will be producer in all cases here
```

```{r figs-dwf-species-sankeys,eval=TRUE, echo=FALSE, results='hide', fig.keep='all', fig.pos='h', fig.cap=paste0(top_6_sp_dwf$common_name, ": caught via DWF by ", country_name, " (source EEZ --> producer --> consumer)")}
# fig.cap = c('first plot', 'second plot') # will provide unique captions to plots
dwf_frgn_consum_sankey <- dwf_frgn_consum %>% 
  exploreARTIS::add_country_name("producer_iso3c") %>% 
  exploreARTIS::add_country_name("consumer_iso3c")

#glimpse(dwf_frgn_consum_sankey)

purrr::map(top_6_sp_dwf$common_name, 
           ~ plot_sankey(dwf_frgn_consum_sankey %>% 
                           filter(.x == common_name),
                         cols = c("eez_name", 
                                  "producer_iso3c_name",
                                  "consumer_iso3c_name"),
                         plot.title = .x) + 
             theme(plot.title = element_text(size=14)) +
             scale_x_discrete(labels = c("EEZ", "producer", "consumer")) +
             theme(axis.text.x = element_text(size = 8))
           )
```

```{r, 5-fig-sankey-dwf, results='asis'}
```

```{r, 6-fig-sankey-dwf, results='asis'}
```

```{r, 7-fig-sankey-dwf, results='asis'}
```

```{r, 8-fig-sankey-dwf, results='asis'}
```

```{r, 9-fig-sankey-dwf, results='asis'}
```

```{r, 10-fig-sankey-dwf, results='asis'}
```


```{r fig-stacked-consum-dwf,eval=TRUE, fig.cap=paste0("Consuming country of aquatic food caught via distant water fishing  by ", country_name, " in the most recent years of data (", paste(unique(dwf_frgn$year), collapse = ", "), ") and not including NAs")}

plot_ts(dwf_frgn,
        artis_var = "consumer_iso3c",
        prop_flow_cutoff = 0.05,
        plot.type = "stacked",
        legend.title = "Consumer") +
  scale_y_continuous(labels = scales::comma)
```

```{r, 4-fig-stacked-consum-dwf, results='asis'}
```


## 3) Consumption of DWF by `r country_name`

```{r fig-consump, eval=TRUE, out.width="100%", fig.width=8.57,fig.cap= paste0(country_name, " consumption of catch from its own waters. Domestic production referes to catch ", country_name, "produces and Foreign fleet production is a foreign country's catch in ", country_name, " water. Note y-axes may not be same scale.")}

# consum_dom is  Focal country consumption of catch in its own waters
# could be domestic catch or catch by a different nation

consum_dom_dom_plot <- consum_dom %>%
  filter(dwf == "domestic",
         producer_iso3c == country_iso3c) %>% 
  mutate(producer_name = countrycode(producer_iso3c,
                                     origin = "iso3c",
                                     destination = "country.name"))

consum_dom_frgn_plot <- consum_dom %>% 
  filter(dwf == "foreign",
         producer_iso3c != country_iso3c) %>% 
  mutate(producer_name = countrycode(producer_iso3c,
                                     origin = "iso3c",
                                     destination = "country.name"))

# Check if the dataframe is empty
if (nrow(consum_dom_frgn_plot) == 0) {
  # Create a new dataframe with the necessary structure and zero values
  consum_dom_frgn_plot <- data.frame(
    year = unique(consum_dom$year),
    producer_name = "None",
    live_weight_t = 0  
  )
}

plot1 <- plot_ts(consum_dom_dom_plot,        
                 artis_var = "producer_name",
                 prop_flow_cutoff = 0.05,
                 plot.type = "stacked",
                 plot.title = "Domestic production"
                 ) +
  scale_y_continuous(labels = scales::comma)

plot2 <- plot_ts(consum_dom_frgn_plot,        
                 artis_var = "producer_name",
                 prop_flow_cutoff = 0.05,
                 plot.type = "stacked",
                 plot.title = "Foreign fleet production"
                 )
# combine plot side-by-side
cowplot::plot_grid(plot1, plot2)
```

```{r, 11-fig-consump, results='asis'}
```

```{r fig-facet-consump, eval=TRUE, out.width="100%", fig.width=8.57, fig.cap=paste0("Fish consumed by ", country_name, " from other countries's waters. The left panel is fish caught by ", country_name, " in another country's EEZ and consumed by ", country_name, ". The middle panel is fish caught by another country in its own waters and consumed by ", country_name, " (this scenario is not DWF). The right panel is fish caught by another country in a different country's EEZ that is consumed by ", country_name,".")}
#
 # facet line plot - - Other EEZ

# create facet variable for 3 other EEZ consumption scenarios:
 #    domestic production by a different country
 #    dwf production from a different country
 #    focal country dwf
consum_frgn_facet <- consum_frgn %>% 
  mutate(
    consum_foreign = case_when(
      dwf == "domestic" & producer_iso3c != country_iso3c ~ 
        "Foreign country's\n domestic production",
      dwf == "foreign" & producer_iso3c != country_iso3c ~ 
        "Foreign country's\n DWF production",
      dwf == "foreign" & producer_iso3c == country_iso3c ~
        glue("{country_name} DWF\nproduction")),
    producer_name = countrycode::countrycode(producer_iso3c,
                                             origin = "iso3c",
                                             destination = "country.name")
  )

(consum_frgn_facet_plot <- plot_ts(consum_frgn_facet,
                                  artis_var = "producer_name",
                                  plot.type = "stacked",
                                  facet_variable = "consum_foreign",
                                  facet_values = 3,
                                  prop_flow_cutoff = 0.05) +
    scale_y_continuous(labels = scales::comma)
  )

```

```{r, 12-fig-facet-consump, results='asis'}
```

**Note**: Data is filtered to the last 5 years of available data

```{r, fig-bar-top-sp-consump, eval=TRUE, fig.cap=paste0("Top species consumed by ", country_name, " caught via distant water fishing by ", country_name, " and other countries. Sum of the most recent years of data available (", paste(unique(consum_dwf$year), collapse = ", "), ").")}

exploreARTIS::plot_bar(data = top_6_sp_consum,
                               bar_group = "common_name",
                               x.lab = "Quantity (tons live weight)") +
  scale_x_continuous(labels = scales::comma) +
  # Add quantity labels for values below the threshold (outside of bar)
  geom_shadowtext(
    data = subset(top_6_sp_consum, 
                  live_weight_t < max(top_6_sp_consum$live_weight_t) * 0.8), 
    aes(x = live_weight_t, y = common_name, 
        label = scales::comma(round(live_weight_t))),
    hjust = 0,
    nudge_x = 0.025 * max(top_6_sp_consum$live_weight_t), # Dynamic nudge value
    colour = "#114F59", # default RGB color from plot_bar
    bg.colour = "white",
    bg.r = 0.2,
    size = 3
  ) +
  # Add quantity labels for values above the threshold (inside bar)
  geom_text(
    data = subset(top_6_sp_consum, 
                  live_weight_t >= max(top_6_sp_consum$live_weight_t) * 0.8),
    aes(x = live_weight_t, y = common_name, 
        label = scales::comma(round(live_weight_t))),
    hjust = 1,
    nudge_x = -0.02 * max(top_6_sp_consum$live_weight_t), # Adjust the nudge value
    colour = "white",
    size = 3
  )


```

```{r, 13-fig-bar-top-sp-consump, results='asis'}
```

```{r}
# New Figure
# Sankey of overall flow (4 columns) with species, EEZ, producer, consumer (or possibly drop species if the 4 columns make it too messy) – focal country will be consumer in all cases here
```

```{r figs-sankey-consump, echo = FALSE, cache = FALSE, results = 'hide', fig.keep = 'all', fig.cap = paste0(top_6_sp_consum$common_name, ": ", country_name, " consumption of distant water fishing products in the most recent available data (", paste(unique(consum_dwf$year), collapse = ", "), "). The flows represent the EEZ where the product was caught --> producer country (who caught the product) --> consumer country (who consumed the end product))")}

purrr::map(top_6_sp_consum$common_name, 
           ~ plot_sankey(consum_dwf %>% 
                           filter(.x == common_name),
                         cols = c("eez_name", 
                                  "producer_iso3c_name",
                                  "consumer_iso3c_name"),
                         plot.title = .x) + 
             theme(plot.title = element_text(size=14)) +
             scale_x_discrete(labels = c("EEZ", "Producer", "Consumer")) +
             theme(axis.text.x = element_text(size = 8)) 
           )
```

```{r, eval= FALSE}
# results <- purrr::map2(top_6_sp_consum$common_name, seq_along(top_6_sp_consum$common_name), 
#                        ~ plot_sankey_annote(consum_dwf, .x, .y, country_iso3c))
```

```{r, eval= FALSE, opts.label='sankey_consump_opts'}
results[1]
```

```{r 14-fig-sankey-consump, results='asis'}
```

```{r, eval= FALSE, opts.label='sankey_consump_opts'}
results[2]
```

```{r 15-fig-sankey-consump, results='asis'}
```

```{r, eval= FALSE}
results[3]
```

```{r 16-fig-sankey-consump, results='asis'}
```

```{r, eval= FALSE}
results[4]
```

```{r 17-fig-sankey-consump, results='asis'}
```

```{r, eval= FALSE}
results[5]
```

```{r 18-fig-sankey-consump, results='asis'}
```

```{r, eval= FALSE}
results[6]
```

```{r 19-fig-sankey-consump, results='asis'}
```
